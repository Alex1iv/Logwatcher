# Logwatcher

## Content

* [Summary](README.md#Summary)  
* [Структура БД](README.md#Структура-БД)  
* [Функции](README.md#Фукнкции)
* [Интеграция СМП с Zabbix](README.md#Интеграция-СМП-с-Zabbix)                    
* [Project structure](README.md#Project-structure)                   

---
## Summary
Система мониторинга петель (СМП) отслеживает появление петель трафика на клиентских портах свитчей и уведомляет администратора о событии в Zabbix.

Петли трафика (Сетевые петли, Network traffic loops) – это опасные состояния, при которых пакеты данных бесконечно циркулируют из-за избыточных соединений (например, двух кабелей между коммутаторами), вызывая сильную перегрузку ЦП оборудования и отказ сети. При возникновении петель необходимо их локализовать их и устранить причину их появления. В нормальном режиме работы свитч автоматически документирует наблюдение петли в файле логов на сервере (Рис. 1). Однако, никаких сообщений системносу администратору не отправляет.

<div align="center">
<img src="./figures/fig.1 - Log_sample.JPG" width="700"/></div> 
<p align="center"> Рис. 1 - Пример петель в логах свитча</p>

## Функции
Основные функции СМП можно разделить на две группы: обработка логов и загрузка списка портов. Архитектура системы представлена на Рис. 2.

<div align="center">
<img src="./figures/fig.2 - System_architecture.png" width="700"/></div>
<p align="center">Рис. 2 - Архитектура системы</p>

Функция обработки логов последовательно выполняет: 
- поиск файлов логов с расширением .log в папке /var/log/rsyslog/. 
- считывание файлов (если таковые найдены) по строкам начиная с точки, с которой остановила чтение в прошлый раз. Список точек остановки хранится в файле /state/file-offsets.json
- парсинг (разбиение) строк на подстроки с помощью регулярного выражения, которое находится в файле parser.py
- экспорт структурированных данных в Postgresql в бд postgres в таблицу log_events.

Функция загрузки данных портов выполняет:
- скачивание файла ports.csv с заданного адреса в папку tmp/ports.csv. Если загрузка не произошла, дальнейших действий не производится.
- чтение данных, переименование ряда признаков, приведение названий портов к единому виду.
- сортировка портов на клиентские и магистральные
- экспорт данных в Postgres c обновлением таблицы ports

## Структура БД
БД postgre содержит:
- таблицу log_events, в которую СМП загружает распарсенные данные логов
- таблицу ports, в которую СМП загружает данные портов
- представление view_for_zabbix, в которое попадают события перенаправления трафика меджу клиентскими и магистральными портами, а другие (между клиентскими или между магистралтными портами) исключаются.

## Интеграция СМП с Zabbix 
Хранение данных в БД Postgres позволяет отправлять уведомления о петлях непосредственно в Zabbix. 

## Установка
1. Клонируем репозиоторий на комп 

```
sudo apt install https://github.com/Alex1iv/Logwatcher.git /usr/share/logwatcher
```

2. Устанавливаем зависимости
```
cd /usr/share/logwatcher
pip install -r requirements.txt
```

3. Запускаем на сервере с файлами логов
```
python3 watcher.py
```
Альтернативно, можно запустить программу в тестовом режиме:
```
python3 watcher.py --remote
```

## Project structure

<details>
  <summary>display project structure </summary>

```Python
├── .gitignore
├── config.yaml         # настройки
├── cred_loader.py      # загрузчик логинов и паролей
├── downloader.py       # загрузчик файлов .csv
├── logging_utils.py    # логгирование
├── logreader.py        # чтение логов
├── logs            
│   └── data.logs       # собственный лог работы программы
├── parser.py           # парсер логов
├── postgres_writer.py  # экспортер данных в postgre
├── README.md           
├── requirements.txt    # список программ установки
├── state
│   └── file-offsets.json   # точки остановки чтения файлов
├── tmp                  # папка загрузки файл с портами
│   └── ports.csv            
└── watcher.py           # основной файл программы
```